---
title: "5_Model_extensions"
author: "S. Jean"
date: "2023-08-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

rm(list = ls())
library(dplyr)
library(tidyr)
library(stringi)
library(ggplot2)
library(here)

# Styling

font_ = 'Helvetica'


```


# I. Oligopoly extension
## A. Define functions

Define : 

-  `q_(x, N, M, ...)` : Cournot harvest with `N` traders and `M` farmers (in metric tons)

-  `cournot_harvest(x, ...)` : Cournot harvest with 1 trader and 1 farmer (in metric tons)

-  `monop_harvest(x, ...)`: Monopoly harvest (in metric tons)

-  `growth(x, ...)` : logistic growth function, yields growth of population (in metric tons) 

```{r}
q_ = function(N,M,x){
  num = N*sigma.^2*x^2*(beta_f. * (M+1)*(alpha_w. - c.) - gamma.*M*(alpha_f.-v.))
  det = sigma.^2 * x^2 * (beta_f. * beta_w.* (N+1) * (M+1) - gamma.^2 * N * M) + 2*W*N*(M+1)*beta_f.
  y = num/det
  return(y)
}


cournot_harvest = function(x, 
                           alpha_f. = alpha_f, 
                           alpha_w. = alpha_w, 
                           beta_f. = beta_f, 
                           beta_w. = beta_w, 
                           gamma. = gamma, 
                           sigma. = sigma, 
                           c. = c, 
                           v. = v, 
                           W. = W_mid){
  y = ((sigma.^2)*(x^2)*(2*beta_f.*(alpha_w. - c.) - gamma.*(alpha_f. - v.)))/(4*beta_f.*W. + (sigma.^2)*(x^2)*(4*beta_f.*beta_w. - (gamma.^2)))
  return(y)
}

monop_harvest = function(x, 
                         alpha. = alpha, 
                         c. = c, 
                         sigma. = sigma, 
                         beta. = beta, 
                         W. = W_mid){
  y = ((alpha. - c.)*sigma.^2 * x^2) / (2*beta.* sigma.^2 * x^2 + 2*W.)
  return(y)
}

growth = function(x, 
                  k.=k, 
                  r.=r){
  y = r.*x*(1-x/k.)
  return(y)
}

###### Linear quadratic model 

monop_harvest_lq = function(x,
                            alpha. = alpha, 
                            c. = c, 
                            sigma. = sigma, 
                            beta. = beta,
                            W1. = W1,
                            W2. = W2){
    y = (sigma.^2 * x^2 * (alpha. - c.) - W1.*sigma.*x)/(2*(beta.*sigma.^2 * x^2 + W2.))
    return(y)
    }


cournot_oligo_harvest_lq = function(N, 
                                    M,
                                    x,
                                    alpha_f. = alpha_f, 
                                    alpha_w. = alpha_w, 
                                    beta_f. = beta_f, 
                                    beta_w. = beta_w, 
                                    gamma. = gamma, 
                                    sigma. = sigma, 
                                    c. = c, 
                                    v. = v, 
                                    W1. = W1,
                                    W2. = W2){
  y = N*( sigma.^2 * x^2 * (beta_f. * (M + 1) * (alpha_w. - c.) - gamma. * M * (alpha_f. - v.)) - W1. * sigma * x * beta_f. * (M+1)) / (sigma.^2 * x^2 * (beta_w. * beta_f. * (M + 1) * (N + 1) - gamma.^2 * N * M) + 2 * N * beta_f. * (M + 1) * W2.)
  return(y)  
}


```


## B. Set data for analysis

```{r, data & analysis}
# Load parameters
calibration = read.csv(here("data", 'outputs', "calibration_params.csv"))

for(i in 1:nrow(calibration)){
  assign(calibration$params[i], calibration$value[i])
}  


# Build the 2nd order parameters from parameter list
  # Differentiate parameters for Wild and Farmed inverse demands
alpha_w = alpha
alpha_f = alpha
beta_w = beta
beta_f = beta
  # Demand functions parameters
e   = gamma/(beta_w*beta_f - (gamma^2))
a_f = (alpha_f*beta_w - alpha_w*gamma)/(beta_w*beta_f - (gamma^2))
a_w = (alpha_w*beta_f - alpha_f*gamma)/(beta_w*beta_f - (gamma^2))
b_f = beta_f/(beta_w*beta_f - (gamma^2))
b_w = beta_w/(beta_w*beta_f - (gamma^2))

W = W_high
# set data : population
data = data.frame(x = seq(1,k))
x_ = seq(1,k)
data = data %>% 
  mutate("Monopoly" = monop_harvest_lq(x_),
         #
         "1 trader - 1 farmer" = cournot_oligo_harvest_lq(1,1,x_), 
         growth = growth(x_),
         '1 trader - 2 farmers' = cournot_oligo_harvest_lq(1,2,x_),
         '1 trader - 5 farmers' = cournot_oligo_harvest_lq(1, 5, x_),
         '1 trader - 10 farmers' = cournot_oligo_harvest_lq(1, 10, x_),
         '1 trader - 50 farmers' = cournot_oligo_harvest_lq(1, 50, x_),
         #
         '2 traders - 1 farmer' = cournot_oligo_harvest_lq(2, 1, x_),
         '2 traders - 2 farmers' = cournot_oligo_harvest_lq(2, 2, x_),
         '2 traders - 5 farmers'  = cournot_oligo_harvest_lq(2,5, x_),
         '2 traders - 10 farmers' = cournot_oligo_harvest_lq(2, 10, x_),
         '2 traders - 50 farmers' = cournot_oligo_harvest_lq(2, 50, x_),
         #
         '5 traders - 1 farmer' = cournot_oligo_harvest_lq(5, 1, x_),
         '5 traders - 2 farmers'  = cournot_oligo_harvest_lq(5, 2, x_),
         '5 traders - 5 farmers'  = cournot_oligo_harvest_lq(5,5,x_),
         '5 traders - 10 farmers' = cournot_oligo_harvest_lq(5,10, x_),
         '5 traders - 50 farmers' = cournot_oligo_harvest_lq(5, 50, x_),
         #
         '10 traders - 1 farmer' = cournot_oligo_harvest_lq(10, 1, x_),
         '10 traders - 2 farmers' = cournot_oligo_harvest_lq(10, 2, x_),
         '10 traders - 5 farmers' = cournot_oligo_harvest_lq(10, 5, x_),
         '10 traders - 10 farmers'= cournot_oligo_harvest_lq(10, 10, x_),
         '10 traders - 50 farmers'= cournot_oligo_harvest_lq(10, 50, x_),
         #
         '50 traders - 1 farmer' = cournot_oligo_harvest_lq(50, 1, x_),
         '50 traders - 2 farmers' = cournot_oligo_harvest_lq(50, 2, x_),
         '50 traders - 5 farmers' = cournot_oligo_harvest_lq(50, 5, x_),
         '50 traders - 10 farmers' = cournot_oligo_harvest_lq(50, 10, x_),
         '50 traders - 50 farmers' = cournot_oligo_harvest_lq(50, 50, x_))%>%
  pivot_longer(cols = -c('x'), # Set to long format for ggplot
              names_to = 'name', 
              values_to = 'values')%>%
  mutate(ss_ = values - growth(x))

levels(data$name) = c('Monopoly',
                      '1 trader - 1 farmer', 
                      '1 trader - 2 farmers',
                      '1 trader - 5 farmers',
                      '1 trader - 10 farmers',
                      '1 trader - 50 farmers',
                      #
                      '2 traders - 1 farmer',
                      "2 traders - 2 farmers",
                      '2 traders - 5 farmers',
                      '2 traders - 10 farmers',
                      '2 traders - 50 farmers',
                      #
                      '5 traders - 1 farmer', 
                      '5 traders - 2 farmers',
                      '5 traders - 5 farmers',
                      '5 traders - 10 farmers',
                      '5 traders - 50 farmers',
                      ###
                      "10 traders - 1 farmer",
                      '10 traders - 2 farmers',
                      '10 traders - 5 farmers',
                      '10 traders - 10 farmers',
                      '10 traders - 50 farmers',
                      #
                      '50 traders - 1 farmer',
                      '50 traders - 2 farmers',
                      '50 traders - 5 farmers',
                      '50 traders - 10 farmers',
                      '50 traders - 50 farmers')


data = data %>% mutate(name2 = sapply(strsplit(name, " - "), `[`, 1),
                       name3 = sapply(strsplit(name, " - "), `[`, 2))


# Smaller dataset 
data2 = data %>%
  subset(!(name %in% c('growth')))%>%
  filter(ss_ < .08 & ss_ > -.08)

# function to create the two groups : less trader or more trader
grouper = function(x){
  if(x %in% c('growth', 'Monopoly', '1 trader - 1 farmer')){
    return('Baseline')
  }else{ # Extract number of farmers and traders and compare them
    a = as.numeric(stri_extract_first_regex(strsplit(x, ' - ')[[1]][1], '[0-9]+'))
    b = as.numeric(stri_extract_first_regex(strsplit(x, ' - ')[[1]][2], '[0-9]+'))
    if(a < b){
      return('More farmers than traders')
    }else if(a >= b){
      return('More traders than farmers')
    }
  }
}

#

data2$grouper = sapply(data2$name, grouper)
data2$order = factor(paste0(data2$name, data2$grouper), c(paste0(levels(data2$name), 'Baseline'),
                                                          paste0(levels(data2$name), 'More farmers than traders'),
                                                          paste0(levels(data2$name), 'More traders than farmers')))


```

## C. Graphical output

```{r, graph1}
palette = c('paleturquoise3', 'steelblue1', 'royalblue1', 'mediumblue', 'navyblue')

monopoly_ss = data2 %>%
  subset(name == 'Monopoly')%>%
  select(x)%>%
  pull()


data2 %>%
  subset(!(grouper %in% c('Baseline')))%>%
  mutate(x_norm = (x - monopoly_ss)/monopoly_ss * 100)%>%
  ggplot(aes(x = order, y = x_norm, colour = name3, shape = name2))+
  facet_grid(~ grouper, scales = 'free')+
  geom_point(size = 2.5)+
  geom_hline(yintercept =0, 
             linetype = "dashed")+
  #scale_x_discrete(limits = levels(data$name))+
  scale_x_discrete(breaks=data2$order, labels=data2$name)+
  #scale_colour_brewer()+
  scale_colour_manual(values = palette)+
  scale_shape_discrete()+
  theme_bw()+
  ylab('Steady state population (in % variation from vertical monopoly scenario)')+
  xlab('')+
  guides(
    color = guide_legend(
      title = " ",  # Title for the first column
      ncol = 1              # Number of columns
    ),
    shape = guide_legend(
      title = " ",     # Title for the second column
      ncol = 1              # Number of columns
    )
  ) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
    #axis.text.x = element_text(angle = 70, 
    #                               hjust = 1, 
    #                               family = font_),
        axis.text.y = element_text(family = font_),
        axis.title.y = element_text(family = font_), 
        strip.text = element_text(family = font_),
        legend.position = 'right',
        legend.text = element_text(family = font_)
        )
ggsave(here('visuals', 'sup_figure1.jpg'), width = 15, height = 18, units = 'cm')
```

```{r, graph2}

data2$name3 = as.factor(data2$name3)
levels(data2$name3) = c('1 farmer', '2 farmers', '5 farmers', '10 farmers', '50 farmers')

data2$name2 = as.factor(data2$name2)
levels(data2$name2) = c('1 trader', '2 traders', '5 traders', '10 traders', '50 traders', 'Monopoly')

data2$order2 = factor(paste0(data2$name3, data2$name2), c(paste0(levels(data2$name2), '1 farmer'),
                                                          paste0(levels(data2$name2), '2 farmer'),
                                                          paste0(levels(data2$name2), '5 farmer'),
                                                          paste0(levels(data2$name2), '10 farmer'),
                                                          paste0(levels(data2$name2), '50 farmer')))

data2 %>%
  subset(!(name %in% c('Monopoly')))%>%
  ggplot(aes(x = order2, y = x, colour = name3))+
  facet_grid(~ name2, scales = 'free')+
  geom_point()+
  geom_hline(yintercept =monopoly_ss, 
             linetype = "dashed")+
  #scale_x_discrete(limits = levels(data$name))+
  scale_x_discrete(breaks=data2$order2, labels=data2$name2)+
  #scale_colour_brewer(palette = 'GnBu')+
  scale_colour_manual(values = palette)+
  theme_bw()+
  guides(
    color = guide_legend(
      title = " ",  # Title for the first column
      ncol = 1              # Number of columns
  ))+
  ylab('Steady state population')+
  xlab('')+
  theme(#axis.text.x = element_text(angle = 70, 
        #                           hjust = 1, 
        #                           family = font_),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y = element_text(family = font_),
        axis.title.y = element_text(family = font_), 
        strip.text = element_text(family = font_),
        legend.position = 'right',
        legend.text = element_text(family = font_)
        )

```

# II. Extended cartel model 
In this section, we investigate the effect of a 'vertical monopoly' take over the aquaculture facility. See supplementary materials section ??? for derivation and discussions. 

## A. Define harvest


```{r, extended cartel}
cournot_harvest_lq = function(x, 
                              alpha_f. = alpha_f, 
                              alpha_w. = alpha_w, 
                              beta_f. = beta_f, 
                              beta_w. = beta_w, 
                              gamma. = gamma, 
                              sigma. = sigma, 
                              c. = c, 
                              v. = v, 
                              W1. = W1, 
                              W2. = W2){
#' Cournot Competition Harvest Function - Linear quadratic model 
#'
#' Computes the harvest in a Cournot competition setting, considering
#' multiple economic factors like production costs, market demand elasticity, and strategic
#' interaction parameters between firms.
#'
#' @param x Numeric, population level at time t
#' @param alpha_f Numeric, demand intercept in USD for farmed product
#' @param alpha_w Numeric, demand intercept in USD for wild product
#' @param beta_f Numeric, demand sensitivity in USD/metric ton for farmed product
#' @param beta_w Numeric, demand sensitivity in USD/metric ton for wild product
#' @param gamma Numeric, demand sensitivity in USD/metric ton for cross product
#' @param sigma Numeric, catchability
#' @param c Numeric, transaction cost for trader
#' @param v Numeric, marginal cost of production for aquaculture
#' @param W1 Numeric, linear fishery effort cost in a linear quadratic model
#' @param W2 Numeric, quadratic fishery effort cost in a linear quadratic model
#'
#' @return Numeric, the calculated output level based on Cournot competition theory adapted to specific market and firm conditions.

 y = ((2*beta_f. * (alpha_w. - c.) - gamma. * (alpha_w. -v.))*sigma.^2 * x^2 - 2*beta_f.*W1.*sigma.*x)/(4*beta_f.*W2. + (4*beta_f.*beta_w. - gamma.^2)*sigma.^2 * x^2)
 return(y)
}


monop_takeover = function(x,
                          alpha_f. = alpha_f, 
                          alpha_w. = alpha_w, 
                          beta_f.  = beta_f, 
                          beta_w.  = beta_w, 
                          gamma.   = gamma, 
                          W1.      = W1,
                          W2.      = W2,
                          c.       = c,
                          v.       = v,
                          sigma.   = sigma){
  num = sigma.^2 * x^2 * (beta_f.*(alpha_w. - c.) - gamma.*(alpha_f. - v.))- W1.*beta_f.*sigma.*x
  den = 2*(beta_f.*W2. + sigma.^2 * x^2 *(beta_f. * beta_w. - gamma.^2))
  y = num/den
  return(y)
}

```

## B. Run scenario

```{r, extended cartel run}
x_ = seq(0,k)
data = data.frame(x = x_)
data = data %>%
  mutate(Growth = growth(x_),
         'Vertical Monopoly' = monop_harvest_lq(x_),
         Cournot = cournot_harvest_lq(x_),
         'Cartel takeover' = monop_takeover(x_))%>%
  pivot_longer(cols = -c('x'),
               names_to = 'name',
               values_to = 'values')%>%
  mutate(values = ifelse(values<0, 0, values))
```

## C. Graphical output
```{r, extended cartel graph}
data %>%
  ggplot(aes(x = x, y = values, color = name))+
  geom_line(linewidth = 1.1)+
  guides(
    color = guide_legend(
      title = " ",  # Title for the first column
      ncol = 1              # Number of columns
    ),
    shape = guide_legend(
      title = " ",     # Title for the second column
      ncol = 1              # Number of columns
    )
  ) +
  scale_color_manual(values = c('purple', '#1f78b4','black','#248721'))+
  scale_linetype_manual(values = c("solid", "solid",'solid', 'dotted' )) +
  ylab('Harvest (in mt)')+
  xlab('Population (in mt)')+  
  theme_bw()+
  theme(axis.text.x = element_text(angle = 70, 
                                   hjust = 1, 
                                   family = font_),
        axis.title.x = element_text(family = font_),
        axis.text.y = element_text(family = font_),
        axis.title.y = element_text(family = font_), 
        strip.text = element_text(family = font_),
        legend.position = 'right',
        legend.text = element_text(family = font_)
        )
  ggsave(here('visuals', 'sup_figure2.png'), width = 15, height = 18, units = 'cm')

```


### Proof of lemmas

```{r, bertrand harvest and inferior to monopoly}

calibration = read.csv(here("data", 'outputs', "calibration_params.csv"))

for(i in 1:nrow(calibration)){
  assign(calibration$params[i], calibration$value[i])
}  


# Build the 2nd order parameters from parameter list
  # Differentiate parameters for Wild and Farmed inverse demands
alpha_w = alpha
alpha_f = alpha
beta_w = beta
beta_f = beta
  # Demand functions parameters
e   = gamma/(beta_w*beta_f - (gamma^2))
a_f = (alpha_f*beta_w - alpha_w*gamma)/(beta_w*beta_f - (gamma^2))
a_w = (alpha_w*beta_f - alpha_f*gamma)/(beta_w*beta_f - (gamma^2))
b_f = beta_f/(beta_w*beta_f - (gamma^2))
b_w = beta_w/(beta_w*beta_f - (gamma^2))

a_m = alpha/beta
b_m = 1/beta

v_bar = function(x){
  const_= (e*a_f + c*(e^2 - 2*b_w*b_f) + 2*b_f*a_w)/(b_f*e)
  w_    = W1*sigma*x*((4*b_f*b_w )*(b_m - b_w) + e^2 *(2*b_w - b_m))/(b_w * b_f * e *(2*sigma^2*x^2 + 2*b_m*W2))
  var_  = (a_m - b_m*c)/(b_w*b_f*e) * (2*W2*b_w*(2*b_w*b_f - e^2) + (4*b_f*b_w - e^2)*sigma^2*x^2)/(2 * sigma^2 * x^2 + 2*b_m*W2)
                                 
  final_= var_ - const_ - w_
  return(w_)
}

data_ = data.frame(x = seq(0,k))%>%
  mutate(v_bar = v_bar(x),
         v_ = v_bar - v)
data_ %>%
   # subset(x > 10000)%>%
  ggplot(aes(x = x, y = v_bar))+
  geom_hline(yintercept = v)+
  geom_line()

```
```{r, check }

params_sensitivity = read.csv(here('data','outputs', 'sensitivity_analysis.csv'))
model_illustration = function(params){
  params = suppressWarnings(as.numeric(unlist(params, use.names = T)))
  beta  = params[1]
  alpha = params[2]
  gamma = params[3]
  W     = params[4]
  W1    = params[5]
  W2    = params[6]
  c     = params[7]
  v     = params[8]
  r     = params[9]
  k     = params[10]
  interest_rate = params[11]
  sigma = params[12]
  identifier = params[15]
  
  # Define functions for model run 
  alpha_w = alpha
  alpha_f = alpha
  beta_w = beta
  beta_f = beta
  # Demand functions parameters
  e   = gamma/(beta_w*beta_f - (gamma^2))
  a_f = (alpha_f*beta_w - alpha_w*gamma)/(beta_w*beta_f - (gamma^2))
  a_w = (alpha_w*beta_f - alpha_f*gamma)/(beta_w*beta_f - (gamma^2))
  b_f = beta_f/(beta_w*beta_f - (gamma^2))
  b_w = beta_w/(beta_w*beta_f - (gamma^2))
  
  growth = function(x, 
                  k.=k, 
                  r.=r){
  y = r.*x*(1-x/k.)
  return(y)
}

  # I. Monopoly
  monop_harvest_lq = function(x,
                              alpha. = alpha, 
                              c. = c, 
                              sigma. = sigma, 
                              beta. = beta,
                              W1. = W1,
                              W2. = W2){
    y = (sigma.^2 * x^2 * (alpha. - c.) - W1.*sigma.*x)/(2*(beta.*sigma.^2 * x^2 + W2.))
    return(y)
  }


  # II. Cournot
  cournot_harvest_lq = function(x, 
                                alpha_f. = alpha_f, 
                                alpha_w. = alpha_w, 
                                beta_f. = beta_f, 
                                beta_w. = beta_w, 
                                gamma. = gamma, 
                                sigma. = sigma, 
                                c. = c, 
                                v. = v, 
                                W1. = W1, 
                                W2. = W2){
    y = ((2*beta_f. * (alpha_w. - c.) - gamma. * (alpha_w. -v.))*sigma.^2 * x^2 - 2*beta_f.*W1.*sigma.*x)/(4*beta_f.*W2. + (4*beta_f.*beta_w. - gamma.^2)*sigma.^2 * x^2)
    return(y)
  }
  
  price_poachers_cournot_lq = function(x,
                                       alpha_f. = alpha_f, 
                                       alpha_w. = alpha_w, 
                                       beta_f. = beta_f, 
                                       beta_w. = beta_w, 
                                       gamma. = gamma, 
                                       sigma. = sigma, 
                                       c. = c, 
                                       v. = v, 
                                       W1. = W1, 
                                       W2. = W2){
    y = (2*W2.*(2*beta_f.*(alpha_w. - c) - gamma.*(alpha_f. - v.)) + W1.*sigma.*x*(4*beta_f.*beta_w. - gamma.^2))/(4*beta_f.*W2. + (4*beta_f.*beta_w. - gamma.^2)*sigma.^2*x^2)
    return(y)
  }
  
  farmed_cournot_lq = function(price_poachers,
                               alpha_f. = alpha_f, 
                               alpha_w. = alpha_w, 
                               beta_f. = beta_f, 
                               beta_w. = beta_w, 
                               gamma. = gamma, 
                               sigma. = sigma, 
                               c. = c, 
                               v. = v, 
                               W1. = W1, 
                               W2. = W2){
    y = (2*beta_w.*(alpha_f. - v.) - gamma.*(alpha_w. - price_poachers - c.))/(4*beta_w.*beta_f. - gamma.^2)
    return(y)
  }

  # III. Bertrand

  bertrand_harvest_lq = function(x,
                                 sigma. = sigma, 
                                 a_f. = a_f, 
                                 a_w. = a_w, 
                                 b_f. = b_f, 
                                 b_w. = b_w, 
                                 e. = e, 
                                 v. = v, 
                                 c. = c, 
                                 W1. = W1, 
                                 W2. = W2){
    y1 = b_w.*(sigma.^2 * x^2 *((2*a_w. +e.*v.)*b_f. + e.*a_f.) + (c. + W1. * sigma. * b_w. * x)*(e.^2 - 2*b_w. *b_f.))
    y2 = 2*W2.*b_w.*(2*b_f.* b_w. - e.^2) + (4*b_f.*b_w. - e.^2)*sigma.^2*x^2
    z = y1/y2
    return(z)
  }

  price_poacher_bertrand_lq = function(x,
                                     sigma. = sigma, 
                                     a_f. = a_f, 
                                     a_w. = a_w, 
                                     b_f. = b_f, 
                                     b_w. = b_w, 
                                     e. = e, 
                                     v. = v, 
                                     c. = c, 
                                     W1. = W1, 
                                     W2. = W2){
  y = 2*b_w.*W2.*((2*a_w. + e.*v.)*b_f. + e.*a_f. + c.*(e.^2 - 2* b_f.*b_w.)) + W1.*sigma.*x*(4*b_f.*b_w. - e.^2)
  z = sigma.^2 * x^2 * (4*b_w.*b_f. - e.^2) + 2*b_w.*W2.*(2*b_f.*b_w - e.^2)
  result = y/z
  return(result)
}

  composite_bertrand_lq = function(x,
                                   sigma. = sigma, 
                                   a_f. = a_f, 
                                   a_w. = a_w, 
                                   b_f. = b_f, 
                                   b_w. = b_w, 
                                   e. = e, 
                                   v. = v, 
                                   c. = c, 
                                   W1. = W1, 
                                   W2. = W2){
    y = b_w. * ((2*a_w. +e.*v.)*b_f. + e.*a_f. + (price_poacher_bertrand_lq(x)+c.)*(e.^2 - 2*b_w.*b_f))/(4*b_f.*b_w. - e.^2)
    return(y)
  }

  bertrand_farmed = function(s,
                             a_f. = a_f, 
                             a_w. = a_w, 
                             b_f. = b_f, 
                             b_w. = b_w, 
                             e. = e, 
                             c. = c, 
                             v. = v){
    y = b_f. *(2*b_w.*a_f. + v.*(e.^2 - 2*b_w.*b_f.) + e.*(a_w. + (s+c.)*b_w.))/(4*b_f.*b_w. - e.^2)
    return(y)
  }
  
  # Run model :
  result1 = data.frame(x = seq(1,k,.5 ))%>%
    mutate(growth= growth(x),
           # Harvests with quadratic and linear-quadratic costs
           monop_harvest_lq = monop_harvest_lq(x),
           cournot_harvest_lq = cournot_harvest_lq(x),
           #bertrand_harvest_lq = bertrand_harvest_lq(x),
           bertrand_harvest_lq = composite_bertrand_lq(x),
           # Prices
           price_poachers_bertrand = price_poacher_bertrand_lq(x),
           price_poachers_cournot = price_poachers_cournot_lq(x),
           # Farmed
           bertrand_farmed_lq = bertrand_farmed(price_poachers_bertrand),
           cournot_farmed_lq = farmed_cournot_lq(price_poachers_cournot),
           # Steady states
           ss_monop_lq = monop_harvest_lq - growth, 
           ss_cournot_lq = cournot_harvest_lq - growth,
           ss_bertrand_lq = bertrand_harvest_lq - growth
           )
  result1 = result1 %>%
    select(x,
           growth, 
           monop_harvest_lq,
           cournot_harvest_lq, 
           bertrand_harvest_lq)
  
    
  return(result1)
}
tester= model_illustration(params_sensitivity[1,])

tester = tester %>%
  mutate(crossing = monop_harvest_lq - bertrand_harvest_lq)

data_ %>%
  mutate(v_ = v_/10)%>%
  subset( v_ > -.2 & v_< .5)

tester %>%
  subset(crossing < .003 & crossing > - .003)

```